<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <title>VWorld 주소 → 마커 + 지번 외곽선 표시</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body { margin:0; font-family:sans-serif; }
    #top { background:#0b69a3; color:white; padding:10px; display:flex; align-items:center; gap:10px; }
    #map { width:100%; height:85vh; }
    #address { flex:1; padding:5px; border-radius:4px; border:1px solid #ccc; }
    button { background:#ff8a00; color:white; border:none; padding:7px 12px; border-radius:4px; cursor:pointer; }
    #info { padding:8px; background:#f3f3f3; font-size:14px; }
  </style>

  <!-- ✅ 최신 VWorld 지도 SDK (OpenLayers6 기반) -->
  <script src="https://map.vworld.kr/js/map/OpenLayers.js"></script>
  <script src="https://map.vworld.kr/js/api/map/OpenLayers-Ext.js"></script>
  <script src="https://map.vworld.kr/js/api/vworldMap.js.do?version=2.0&apiKey=BE552462-0744-32DB-81E7-1B7317390D68"></script>
</head>
<body>
  <div id="top">
    <span>주소 입력:</span>
    <input id="address" placeholder="예: 전라남도 해남군 북평면 동해길 43-36" />
    <button onclick="searchAddress()">찾기</button>
    <button onclick="clearMap()">초기화</button>
  </div>
  <div id="map"></div>
  <div id="info">검색 결과가 여기에 표시됩니다.</div>

  <script>
    let map, markerLayer, vectorLayer;

    window.onload = function() {
      // ✅ VWorld 지도 생성
      map = new vworld.Map("map", {
        basemapType: vworld.BasemapType.GRAPHIC,
        controlDensity: vworld.DensityType.BASIC,
        interactionDensity: vworld.DensityType.BASIC,
        controlsAutoArrange: true,
        homePosition: vworld.PositionType.DEFAULT,
        initPosition: vworld.PositionType.DEFAULT
      });

      markerLayer = new vworld.MarkerLayer();
      vectorLayer = new vworld.VectorLayer();
      map.addLayer(markerLayer);
      map.addLayer(vectorLayer);
    };

    // ✅ 주소 → 좌표 변환 (VWorld Geocoding API)
    async function searchAddress() {
      const address = document.getElementById('address').value.trim();
      if (!address) { alert('주소를 입력하세요.'); return; }

      const url = `https://api.vworld.kr/req/address?service=address&request=getCoord&key=BE552462-0744-32DB-81E7-1B7317390D68&type=ROAD&format=json&address=${encodeURIComponent(address)}`;
      document.getElementById('info').innerText = "주소 변환 중...";

      try {
        const res = await fetch(url);
        const json = await res.json();

        const item = json?.response?.result?.point;
        if (!item) throw new Error('좌표를 찾지 못했습니다.');

        const lon = parseFloat(item.x);
        const lat = parseFloat(item.y);

        addMarker(lon, lat, address);
        map.setCenter(new OpenLayers.LonLat(lon, lat).transform("EPSG:4326", "EPSG:900913"), 17);

        document.getElementById('info').innerText = `위치: ${lon}, ${lat}`;
        await showParcelBoundary(lon, lat); // 외곽선 표시
      } catch (err) {
        console.error(err);
        alert("주소를 찾을 수 없습니다.");
      }
    }

    // ✅ 마커 표시
    function addMarker(lon, lat, title) {
      markerLayer.removeAllFeatures();
      const marker = new vworld.Marker(lon, lat, { title });
      markerLayer.addMarker(marker);
    }

    // ✅ 필지 외곽선 표시 (VWorld 2D data API 사용)
    async function showParcelBoundary(lon, lat) {
      vectorLayer.removeAllFeatures();

      const url = `https://api.vworld.kr/ned/data/getLandCharacteristics?key=BE552462-0744-32DB-81E7-1B7317390D68&domain=&format=json&numOfRows=10&pageNo=1&geomFilter=point(${lon} ${lat})&stdrYear=2020`;
      try {
        const res = await fetch(url);
        const json = await res.json();

        const pnu = json?.response?.field?.pnu;
        if (!pnu) {
          document.getElementById('info').innerText += " | 필지정보 없음";
          return;
        }

        // PNU로 필지 폴리곤 요청
        const polygonUrl = `https://api.vworld.kr/ned/data/getParcel?key=BE552462-0744-32DB-81E7-1B7317390D68&domain=&pnu=${pnu}&format=json`;
        const polyRes = await fetch(polygonUrl);
        const polyJson = await polyRes.json();

        if (polyJson?.response?.field?.polygon) {
          const wkt = polyJson.response.field.polygon;
          const feature = new OpenLayers.Format.WKT().read(wkt);
          feature.geometry.transform("EPSG:4326", "EPSG:900913");

          vectorLayer.addFeatures([feature]);
          document.getElementById('info').innerText += ` | 지번 외곽선 표시 완료 (PNU: ${pnu})`;
        } else {
          document.getElementById('info').innerText += " | 외곽선 데이터 없음";
        }
      } catch (e) {
        console.error(e);
        document.getElementById('info').innerText += " | 외곽선 표시 실패";
      }
    }

    // ✅ 초기화 버튼
    function clearMap() {
      markerLayer.removeAllFeatures();
      vectorLayer.removeAllFeatures();
      document.getElementById('info').innerText = "지도 초기화됨.";
    }
  </script>
</body>
</html>
