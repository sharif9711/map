<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<title>VWorld 주소 검색 및 필지 경계선 표시</title>
<script type="text/javascript" src="http://map.vworld.kr/js/vworldMapInit.js.do?version=2.0&apiKey=BE552462-0744-32DB-81E7-1B7317390D68&domain=localhost:8080"></script>
<style>
    /* 지도 전체 화면 설정 */
    html, body, #vmap {
        width: 100%;
        height: 100%;
        margin: 0;
        padding: 0;
    }
    /* 검색창 스타일 */
    .search-container {
        position: absolute;
        top: 20px;
        left: 50px;
        z-index: 1000;
        background: white;
        padding: 10px;
        border-radius: 5px;
        box-shadow: 0 2px 5px rgba(0,0,0,0.3);
    }
    #address-input {
        width: 250px;
        padding: 8px;
        border: 1px solid #ccc;
        border-radius: 3px;
    }
    #search-button {
        padding: 8px 12px;
        border: none;
        background-color: #007bff;
        color: white;
        border-radius: 3px;
        cursor: pointer;
    }
    #search-button:hover {
        background-color: #0056b3;
    }
</style>
</head>

<body>

<div id="vmap"></div>
<div class="search-container">
    <input type="text" id="address-input" placeholder="예) 서울특별시 종로구 세종대로 1">
    <button id="search-button">검색</button>
</div>

<script type="text/javascript">
    // --- 1. VWorld 지도 생성 (샘플 코드 기반) ---
    vw.ol3.MapOptions = {
        basemapType: vw.ol3.BasemapType.GRAPHIC,
        controlDensity: vw.ol3.DensityType.EMPTY,
        interactionDensity: vw.ol3.DensityType.BASIC,
        controlsAutoArrange: true,
        homePosition: vw.ol3.CameraPosition,
        initPosition: vw.ol3.CameraPosition
    };
    let vmap = new vw.ol3.Map("vmap", vw.ol3.MapOptions);

    // --- 2. 마커와 벡터(폴리곤)를 그릴 레이어 생성 ---
    let markerLayer = new vw.ol3.layer.Marker(vmap);
    let vectorLayer = new vw.ol3.layer.Vector(vmap); // 필지 경계선을 그릴 레이어
    vmap.addLayer(markerLayer);
    vmap.addLayer(vectorLayer);

    // --- 3. 주소 검색 및 표시 함수 ---
    async function searchAndDisplay(address) {
        try {
            // --- 1단계: 주소 -> 좌표 변환 (API 호출) ---
            const geocodeUrl = `https://api.vworld.kr/req/address?service=address&request=getcoord&version=2.0&crs=epsg:4326&address=${encodeURIComponent(address)}&format=json&type=parcel&key=BE552462-0744-32DB-81E7-1B7317390D68`;
            const geoResponse = await fetch(geocodeUrl);
            const geoResult = await geoResponse.json();

            if (geoResult.response.status !== "OK") {
                throw new Error("주소를 찾을 수 없습니다.");
            }

            const { x: lon, y: lat } = geoResult.response.result.point;
            console.log(`1단계 성공: 주소 "${address}"의 좌표 -> (${lon}, ${lat})`);

            // --- 이전 결과 지우기 ---
            markerLayer.clear();
            vectorLayer.clear();

            // --- 2단계: 마커 표시 ---
            // ★★★ 중요: EPSG:4326 좌표를 VWorld 지도용 EPSG:900913 좌표로 변환
            const transformedCoords = vw.ol3.Projection.transform([lon, lat], "EPSG:4326", "EPSG:900913");

            const markerOption = {
                x: transformedCoords[0],
                y: transformedCoords[1],
                title: address,
                contents: `<b>${address}</b>`,
                iconUrl: 'http://map.vworld.kr/images/ol3/marker_blue.png'
            };
            markerLayer.addMarker(markerOption);

            // --- 3단계: 필지 폴리곤 조회 (API 호출) ---
            const dataUrl = `http://api.vworld.kr/req/data?key=BE552462-0744-32DB-81E7-1B7317390D68&service=data&version=2.0&request=getfeature&format=json&size=1&page=1&data=LP_PA_CBND_BUBUN&geometry=true&attribute=true&crs=EPSG:4326&geomfilter=POINT(${lon} ${lat})`;
            const dataResponse = await fetch(dataUrl);
            const dataResult = await dataResponse.json();

            if (dataResult.response.status !== "OK" || dataResult.response.result.featureCollection.features.length === 0) {
                throw new Error("해당 위치에 필지 정보가 없습니다.");
            }

            const polygonCoords = dataResult.response.result.featureCollection.features[0].geometry.coordinates[0];
            console.log("3단계 성공: 필지 폴리곤 좌표 조회 완료.");

            // --- 4단계: 필지 경계선 표시 ---
            // ★★★ 중요: 폴리곤의 모든 좌표를 EPSG:900913으로 변환
            const transformedPolygonCoords = polygonCoords.map(coord => {
                return vw.ol3.Projection.transform(coord, "EPSG:4326", "EPSG:900913");
            });

            // VWorld의 폴리곤 피처 생성
            const polygonFeature = new vw.ol3.feature.Polygon(transformedPolygonCoords, {
                style: {
                    strokeColor: '#ff0000', // 테두리 색상
                    strokeWidth: 3,       // 테두리 두께
                    fillColor: '#ff7800', // 채우기 색상
                    fillOpacity: 0.3      // 채우기 투명도
                }
            });

            // 벡터 레이어에 폴리곤 피처 추가
            vectorLayer.addFeature(polygonFeature);

            // --- 5단계: 지도 시점 조정 ---
            // 마커와 폴리곤이 모두 보이도록 영역 계산
            const extent = vw.ol3.extent.createEmpty();
            vw.ol3.extent.extend(extent, transformedCoords);
            transformedPolygonCoords.forEach(coord => vw.ol3.extent.extend(extent, coord));
            vmap.zoomToExtent(extent);

        } catch (error) {
            console.error(error);
            alert(error.message);
        }
    }

    // --- 4. 이벤트 리스너 ---
    const searchButton = document.getElementById('search-button');
    const addressInput = document.getElementById('address-input');

    searchButton.addEventListener('click', () => {
        const address = addressInput.value.trim();
        if (address) {
            searchAndDisplay(address);
        } else {
            alert("주소를 입력해주세요.");
        }
    });

    addressInput.addEventListener('keydown', (event) => {
        if (event.key === 'Enter') {
            searchButton.click();
        }
    });

</script>
</body>
</html>
