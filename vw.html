<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8">
<title>VWorld 주소 → 필지 경계선 표시 (안정화 버전)</title>

<!-- ✅ VWorld 2D 지도 SDK -->
<script src="https://map.vworld.kr/js/vworldMapInit.js.do?version=2.0&apiKey=BE552462-0744-32DB-81E7-1B7317390D68"></script>
<!-- ✅ jQuery -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<style>
  body { margin:0; font-family:Arial,sans-serif; }
  #topbar {
    background:#0b69a3; color:white; padding:10px;
    display:flex; align-items:center; gap:10px;
  }
  #addrInput { flex:1; padding:6px; border:1px solid #ccc; border-radius:4px; }
  #map { width:100%; height:85vh; }
  button {
    background:#ff8a00; color:white; border:none; border-radius:4px;
    padding:6px 12px; cursor:pointer;
  }
  #info { padding:8px; background:#f5f5f5; font-size:14px; }
</style>
</head>

<body>
  <div id="topbar">
    <span>주소 입력:</span>
    <input id="addrInput" placeholder="예: 전라남도 해남군 북평면 동해길 43-36">
    <button id="searchBtn">찾기</button>
    <button id="resetBtn">초기화</button>
  </div>
  <div id="map"></div>
  <div id="info">지도 로딩 중...</div>

<script>
const apiKey = "BE552462-0744-32DB-81E7-1B7317390D68";
let vmap, markerLayer, vectorSource, vectorLayer;

// ✅ SDK 로드 대기 함수
function waitForVworldReady() {
  if (window.vw && vw.ol3 && vw.ol3.Map) {
    console.log("✅ VWorld SDK 로드 완료");
    initMap();
  } else {
    console.log("⏳ VWorld SDK 로드 대기 중...");
    setTimeout(waitForVworldReady, 300);
  }
}

// ✅ 지도 초기화
function initMap() {
  vw.ol3.MapOptions = {
      basemapType: vw.ol3.BasemapType.GRAPHIC,
      controlDensity: vw.ol3.DensityType.BASIC,
      interactionDensity: vw.ol3.DensityType.BASIC,
      controlsAutoArrange: true
  };
  vmap = new vw.ol3.Map("map", vw.ol3.MapOptions);

  markerLayer = new vw.ol3.layer.Marker(vmap);
  vmap.addLayer(markerLayer);

  vectorSource = new ol.source.Vector();
  vectorLayer = new ol.layer.Vector({
    source: vectorSource,
    style: new ol.style.Style({
      stroke: new ol.style.Stroke({ color: 'rgba(0,128,255,0.9)', width: 3 }),
      fill: new ol.style.Fill({ color: 'rgba(0,128,255,0.15)' })
    })
  });
  vmap.addLayer(vectorLayer);

  $("#info").text("지도 준비 완료. 주소를 입력해보세요.");

  $("#searchBtn").on("click", searchAddress);
  $("#resetBtn").on("click", resetMap);
}

// ✅ 주소 검색
function searchAddress() {
  const addr = $("#addrInput").val().trim();
  if (!addr) return alert("주소를 입력하세요.");
  $("#info").text("주소 좌표 조회 중...");

  $.ajax({
    url: "https://api.vworld.kr/req/address",
    dataType: "jsonp",
    data: {
      service: "address",
      request: "getCoord",
      key: apiKey,
      type: "ROAD",
      format: "json",
      address: addr
    },
    success: function(res) {
      const point = res?.response?.result?.point;
      if (!point) return alert("주소를 찾을 수 없습니다.");

      const lon = parseFloat(point.x);
      const lat = parseFloat(point.y);
      addMarker(lon, lat);
      $("#info").text(`좌표(${lon}, ${lat}) → PNU 조회 중...`);
      getPNU(lon, lat);
    },
    error: () => $("#info").text("지오코딩 실패")
  });
}

// ✅ 좌표 → PNU 조회
function getPNU(lon, lat) {
  $.ajax({
    url: "https://api.vworld.kr/ned/data/getLandCharacteristics",
    dataType: "jsonp",
    data: {
      key: apiKey,
      format: "json",
      geomFilter: `point(${lon} ${lat})`,
      stdrYear: "2020"
    },
    success: function(res) {
      const pnu = res?.response?.field?.pnu;
      if (!pnu) return $("#info").text("PNU 코드 조회 실패");
      $("#info").text(`PNU: ${pnu} → 필지 경계 조회 중...`);
      getParcel(pnu);
    },
    error: () => $("#info").text("PNU 조회 실패")
  });
}

// ✅ PNU → 필지 polygon
function getParcel(pnu) {
  $.ajax({
    url: "https://api.vworld.kr/req/data",
    dataType: "jsonp",
    data: {
      service: "data",
      request: "getFeature",
      key: apiKey,
      data: "LP_PA_CBND_BUBUN",
      attrFilter: `pnu:${pnu}`,
      format: "json"
    },
    success: function(res) {
      try {
        const polygon = res.response.result.featureCollection.features[0].properties.polygon;
        drawPolygon(polygon);
        $("#info").text("✅ 필지 경계선 표시 완료!");
      } catch {
        $("#info").text("해당 필지의 경계선 정보를 찾을 수 없습니다.");
      }
    },
    error: () => $("#info").text("필지 경계선 API 호출 실패")
  });
}

// ✅ 마커 추가
function addMarker(lon, lat) {
  markerLayer.clear();
  vw.ol3.markerOption = {
    x: lon, y: lat, epsg: "EPSG:4326",
    title: "검색위치",
    contents: "입력한 주소 위치입니다.",
    iconUrl: "https://map.vworld.kr/images/ol3/marker_blue.png"
  };
  markerLayer.addMarker(vw.ol3.markerOption);
  const center = ol.proj.transform([lon, lat], "EPSG:4326", "EPSG:900913");
  vmap.getView().setCenter(center);
  vmap.getView().setZoom(18);
}

// ✅ 폴리곤 표시
function drawPolygon(wkt) {
  vectorSource.clear();
  const format = new ol.format.WKT();
  const feature = format.readFeature(wkt, {
    dataProjection: "EPSG:4326",
    featureProjection: "EPSG:900913"
  });
  vectorSource.addFeature(feature);
  vmap.getView().fit(feature.getGeometry().getExtent(), { padding:[20,20,20,20], maxZoom:19 });
}

// ✅ 초기화
function resetMap() {
  markerLayer.clear();
  vectorSource.clear();
  $("#info").text("지도 초기화 완료.");
}

// ✅ 실행
$(document).ready(waitForVworldReady);
</script>
</body>
</html>
