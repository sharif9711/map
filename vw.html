<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8">
<title>주소로 필지 경계선 표시</title>

<!-- ✅ VWorld 지도 SDK (HTTPS 로드 필수) -->
<script src="https://map.vworld.kr/js/vworldMapInit.js.do?version=2.0&apiKey=BE552462-0744-32DB-81E7-1B7317390D68"></script>

<!-- ✅ jQuery (JSONP용) -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<style>
  body { margin:0; font-family:Arial, sans-serif; }
  #topbar {
    background:#0b69a3; color:#fff; padding:10px; display:flex; gap:10px; align-items:center;
  }
  #addrInput {
    flex:1; padding:6px; border-radius:4px; border:1px solid #ccc;
  }
  #map { width:100%; height:85vh; }
  button {
    border:none; padding:6px 12px; border-radius:4px;
    background:#ff8a00; color:white; cursor:pointer;
  }
  #info {
    padding:8px; background:#f6f6f6; font-size:14px;
  }
</style>
</head>

<body>
  <div id="topbar">
    <span>주소 입력:</span>
    <input id="addrInput" placeholder="예: 전라남도 해남군 북평면 덕도리 233">
    <button id="searchBtn">찾기</button>
    <button id="resetBtn">초기화</button>
  </div>

  <div id="map"></div>
  <div id="info">지도 준비 중...</div>

<script>
const apiKey = "BE552462-0744-32DB-81E7-1B7317390D68";
let vmap, markerLayer, vectorLayer;

// ✅ 지도 초기화
function initMap() {
  vw.ol3.MapOptions = {
      basemapType: vw.ol3.BasemapType.GRAPHIC,
      controlDensity: vw.ol3.DensityType.EMPTY,
      interactionDensity: vw.ol3.DensityType.BASIC,
      controlsAutoArrange: true,
      homePosition: vw.ol3.CameraPosition,
      initPosition: vw.ol3.CameraPosition
  };
  vmap = new vw.ol3.Map("map", vw.ol3.MapOptions);
  markerLayer = new vw.ol3.layer.Marker(vmap);
  vectorLayer = new vw.ol3.layer.Vector(vmap);
  vmap.addLayer(markerLayer);
  vmap.addLayer(vectorLayer);
  $("#info").text("지도 준비 완료. 주소를 입력해보세요.");
}

// ✅ 1️⃣ 주소 → 좌표 변환
function searchAddress() {
  const addr = $("#addrInput").val().trim();
  if (!addr) return alert("주소를 입력하세요.");
  $("#info").text("주소 변환 중...");

  $.ajax({
    url: "https://api.vworld.kr/req/address",
    dataType: "jsonp",
    data: {
      service: "address",
      request: "getCoord",
      key: apiKey,
      type: "ROAD", // 도로명 기준 (지번으로 하려면 'PARCEL')
      format: "json",
      address: addr
    },
    success: function(res) {
      try {
        const point = res.response.result.point;
        const lon = parseFloat(point.x);
        const lat = parseFloat(point.y);
        $("#info").text(`좌표 (${lon}, ${lat}) → PNU 조회 중...`);
        showMarker(lon, lat);
        getPNU(lon, lat);
      } catch(e) {
        $("#info").text("주소를 찾을 수 없습니다.");
      }
    },
    error: () => $("#info").text("지오코딩 요청 실패")
  });
}

// ✅ 2️⃣ 좌표 → PNU 조회
function getPNU(lon, lat) {
  $.ajax({
    url: "https://api.vworld.kr/ned/data/getLandCharacteristics",
    dataType: "jsonp",
    data: {
      key: apiKey,
      format: "json",
      geomFilter: `point(${lon} ${lat})`,
      stdrYear: "2020"
    },
    success: function(res) {
      const pnu = res?.response?.field?.pnu;
      if (pnu) {
        $("#info").text(`PNU: ${pnu} → 필지 경계 조회 중...`);
        getParcelPolygon(pnu);
      } else {
        $("#info").text("PNU 코드 조회 실패");
      }
    },
    error: () => $("#info").text("PNU API 호출 실패")
  });
}

// ✅ 3️⃣ PNU → Polygon 좌표 가져오기
function getParcelPolygon(pnu) {
  $.ajax({
    url: "https://api.vworld.kr/req/data",
    dataType: "jsonp",
    data: {
      service: "data",
      request: "getFeature",
      key: apiKey,
      data: "LP_PA_CBND_BUBUN", // 연속지적도 데이터셋
      attrFilter: `pnu:${pnu}`,
      format: "json"
    },
    success: function(res) {
      try {
        const polygon = res.response.result.featureCollection.features[0].properties.polygon;
        drawPolygon(polygon);
        $("#info").text("✅ 필지 경계선 표시 완료!");
      } catch(e) {
        $("#info").text("해당 필지의 경계선을 찾을 수 없습니다.");
      }
    },
    error: () => $("#info").text("필지 경계 데이터 조회 실패")
  });
}

// ✅ 지도에 마커 표시
function showMarker(lon, lat) {
  markerLayer.removeAll();
  vw.ol3.markerOption = {
    x: lon, y: lat, epsg: "EPSG:4326",
    title: "검색위치", contents: "주소 검색 결과",
    iconUrl: "https://map.vworld.kr/images/ol3/marker_blue.png"
  };
  markerLayer.addMarker(vw.ol3.markerOption);
  vmap.getView().setCenter(ol.proj.transform([lon, lat], "EPSG:4326", "EPSG:900913"));
  vmap.getView().setZoom(18);
}

// ✅ polygon WKT → 지도에 경계 표시
function drawPolygon(wkt) {
  vectorLayer.clear();
  const format = new ol.format.WKT();
  const feature = format.readFeature(wkt, {
    dataProjection: "EPSG:4326",
    featureProjection: "EPSG:900913"
  });
  feature.setStyle(new ol.style.Style({
    stroke: new ol.style.Stroke({ color: "rgba(0,128,255,0.9)", width: 3 }),
    fill: new ol.style.Fill({ color: "rgba(0,128,255,0.15)" })
  }));
  vectorLayer.addFeature(feature);
  const extent = feature.getGeometry().getExtent();
  vmap.getView().fit(extent, { padding:[20,20,20,20], maxZoom:19 });
}

// ✅ 초기화
function resetMap() {
  markerLayer.removeAll();
  vectorLayer.clear();
  $("#info").text("지도 초기화 완료.");
}

// ✅ 실행
$(document).ready(() => {
  initMap();
  $("#searchBtn").on("click", searchAddress);
  $("#resetBtn").on("click", resetMap);
});
</script>
</body>
</html>
