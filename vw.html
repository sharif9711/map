<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8">
<title>주소로 필지 경계선 표시 (안정화 버전)</title>

<!-- ✅ VWorld SDK -->
<script src="https://map.vworld.kr/js/map/OpenLayers.js"></script>
<script src="https://map.vworld.kr/js/api/map/OpenLayers-Ext.js"></script>
<script src="https://map.vworld.kr/js/api/vworldMap.js.do?version=2.0&apiKey=BE552462-0744-32DB-81E7-1B7317390D68"></script>

<!-- ✅ jQuery -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<style>
body { margin:0; font-family:Arial,sans-serif; }
#topbar {
  background:#0b69a3; color:white; padding:10px;
  display:flex; align-items:center; gap:10px;
}
#addrInput { flex:1; padding:6px; border:1px solid #ccc; border-radius:4px; }
button {
  background:#ff8a00; color:white; border:none;
  padding:6px 12px; border-radius:4px; cursor:pointer;
}
#map { width:100%; height:85vh; }
#info { padding:8px; background:#f5f5f5; font-size:14px; }
</style>
</head>

<body>
  <div id="topbar">
    <span>주소 입력:</span>
    <input id="addrInput" placeholder="예: 전라남도 해남군 북평면 동해길 43-36">
    <button id="searchBtn">찾기</button>
    <button id="resetBtn">초기화</button>
  </div>
  <div id="map"></div>
  <div id="info">지도 준비 중...</div>

<script>
const apiKey = "BE552462-0744-32DB-81E7-1B7317390D68";
let map, vectorLayer, vectorSource, markerLayer;

// ✅ SDK 로드 확인 후 실행
function waitForVWorld() {
  if (typeof vworld !== "undefined" && vworld.Map) {
    console.log("✅ VWorld SDK 로드 완료");
    initMap();
  } else {
    console.log("⏳ SDK 대기 중...");
    setTimeout(waitForVWorld, 300);
  }
}

// ✅ 지도 초기화
function initMap() {
  map = new vworld.Map("map", {
    basemapType: vworld.BasemapType.GRAPHIC,
    controlDensity: vworld.DensityType.BASIC,
    interactionDensity: vworld.DensityType.BASIC,
    controlsAutoArrange: true,
    homePosition: vworld.PositionType.DEFAULT,
    initPosition: vworld.PositionType.DEFAULT
  });

  vectorSource = new OpenLayers.Layer.Vector("Polygon Layer");
  map.addLayer(vectorSource);

  $("#info").text("지도 준비 완료. 주소를 입력하세요.");
  $("#searchBtn").on("click", searchAddress);
  $("#resetBtn").on("click", resetMap);
}

// ✅ 주소 → 좌표
function searchAddress() {
  const addr = $("#addrInput").val().trim();
  if (!addr) return alert("주소를 입력하세요.");
  $("#info").text("주소 변환 중...");

  $.ajax({
    url: "https://api.vworld.kr/req/address",
    dataType: "jsonp",
    data: {
      service: "address",
      request: "getCoord",
      key: apiKey,
      type: "ROAD",
      format: "json",
      address: addr
    },
    success: function(res) {
      const point = res?.response?.result?.point;
      if (!point) return $("#info").text("주소를 찾을 수 없습니다.");
      const lon = parseFloat(point.x);
      const lat = parseFloat(point.y);
      addMarker(lon, lat);
      getPNU(lon, lat);
      $("#info").text(`좌표(${lon}, ${lat}) → PNU 조회 중...`);
    },
    error: () => $("#info").text("주소 변환 실패")
  });
}

// ✅ 좌표 → PNU
function getPNU(lon, lat) {
  $.ajax({
    url: "https://api.vworld.kr/ned/data/getLandCharacteristics",
    dataType: "jsonp",
    data: {
      key: apiKey,
      format: "json",
      geomFilter: `point(${lon} ${lat})`,
      stdrYear: "2020"
    },
    success: function(res) {
      const pnu = res?.response?.field?.pnu;
      if (!pnu) return $("#info").text("PNU 코드 조회 실패");
      $("#info").text(`PNU: ${pnu} → 필지 경계 조회 중...`);
      getParcelPolygon(pnu);
    },
    error: () => $("#info").text("PNU API 요청 실패")
  });
}

// ✅ PNU → polygon
function getParcelPolygon(pnu) {
  $.ajax({
    url: "https://api.vworld.kr/req/data",
    dataType: "jsonp",
    data: {
      service: "data",
      request: "getFeature",
      key: apiKey,
      data: "LP_PA_CBND_BUBUN",
      attrFilter: `pnu:${pnu}`,
      format: "json"
    },
    success: function(res) {
      try {
        const polygon = res.response.result.featureCollection.features[0].properties.polygon;
        drawPolygon(polygon);
        $("#info").text("✅ 필지 경계선 표시 완료!");
      } catch (e) {
        $("#info").text("필지 경계 데이터를 찾을 수 없습니다.");
      }
    },
    error: () => $("#info").text("필지 경계 API 실패")
  });
}

// ✅ 마커 표시
function addMarker(lon, lat) {
  if (markerLayer) map.removeLayer(markerLayer);
  markerLayer = new OpenLayers.Layer.Markers("Marker Layer");
  map.addLayer(markerLayer);

  const lonLat = new OpenLayers.LonLat(lon, lat).transform(
    new OpenLayers.Projection("EPSG:4326"),
    map.getProjectionObject()
  );
  const marker = new OpenLayers.Marker(lonLat);
  markerLayer.addMarker(marker);
  map.setCenter(lonLat, 18);
}

// ✅ 폴리곤 표시
function drawPolygon(wkt) {
  vectorSource.removeAllFeatures();
  const format = new OpenLayers.Format.WKT();
  const feature = format.read(wkt);
  vectorSource.addFeatures([feature]);
  map.zoomToExtent(feature.geometry.getBounds());
}

// ✅ 초기화
function resetMap() {
  if (markerLayer) map.removeLayer(markerLayer);
  if (vectorSource) vectorSource.removeAllFeatures();
  $("#info").text("지도 초기화 완료.");
}

// ✅ 실행
$(document).ready(waitForVWorld);
</script>
</body>
</html>
